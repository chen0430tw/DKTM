# DKTM - Dynamic Kernel Transition Mechanism

**一键热重启系统 - 无需完全重启即可重置 Windows 内核**

> "Jerry 探头看 Tom 走了没有，然后一键穿越到另一个世界" 🐭💨

---

## 🎯 这是什么？

DKTM 是一个**真正的一键热重启系统**，不是简单的 bcdedit 套壳。

**一键热重启流程**：
```
按下按钮 → SOSA 智能探测 → 自动切 PE → 重置内核 → 自动回 Windows
```

**全程自动，无需手动操作**。

---

## ✨ 核心特性

### 🧠 SOSA 智能决策
- **自研算法**：Jerry 式探测，实时监控系统压力
- **安全评估**：E_mean < 0.5 才执行，确保系统安全
- **自动决策**：不需要人工判断，系统自己知道什么时候可以重启

### 🚀 一键热重启
- **一个命令**：`python hot_restart.py`
- **自动切换**：自动进入 WinPE → 重置内核 → 自动回主系统
- **全自动化**：不需要手动配置 BCD、不需要手动重启

### 🛡️ 安全机制
- **Dry-Run 模式**：测试时不会真的重启
- **自动备份**：BCD 配置自动备份，可回滚
- **智能验证**：每步都有验证，失败自动中止

---

## 📦 快速开始

### 1. 系统要求

- Windows 10/11 (64-bit)
- 管理员权限
- Python 3.7+
- Windows ADK（会自动检测）

### 2. 安装依赖

```bash
# 安装 Python 依赖
pip install -r requirements.txt

# 或手动安装
pip install numpy pyyaml
```

### 3. 一键安装

```bash
# 以管理员身份运行
python install.py
```

**安装过程自动完成**：
- ✅ 自动构建 WinPE（集成 DKTM 恢复脚本）
- ✅ 自动创建 BCD 条目
- ✅ 自动配置系统
- ✅ 自动验证安装

### 4. 一键热重启

```bash
# 测试模式（不会真的重启）
python hot_restart.py --dry-run

# 真实执行（Jerry 出洞！）
python hot_restart.py
```

**就这么简单！** 🎉

---

## 🔧 高级用法

### 手动分步安装

如果你想手动控制每一步：

```bash
# 1. 构建 WinPE
python tools/build_pe.py --deploy

# 2. 配置 BCD
python tools/setup_bcd.py --save-config

# 3. 验证配置
python hot_restart.py --dry-run
```

### 强制执行（跳过安全检查）

```bash
# 不推荐！除非你知道自己在做什么
python hot_restart.py --force
```

### 使用自定义配置

```bash
python hot_restart.py --config my_config.yaml
```

---

## 📚 工作原理

### 架构图

```
┌─────────────────────────────────────────────────┐
│  用户按下按钮 (python hot_restart.py)          │
└───────────────────┬─────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  SOSA 智能探测 (Jerry 探头)                    │
│  - 采集系统状态                                 │
│  - 计算 E_mean (系统压力)                       │
│  - 决定是否安全                                 │
└───────────────────┬─────────────────────────────┘
                    ↓
         [安全?] ━━━━━━━━━━━┓
            ↓ 是             ↓ 否
┌─────────────────────┐   ┌────────────────┐
│  自动切换到 PE      │   │  中止操作      │
│  - 设置 BCD         │   │  等待更好时机  │
│  - 触发重启         │   └────────────────┘
└──────────┬──────────┘
           ↓
┌─────────────────────────────────────────────────┐
│  WinPE 自动执行 (在 PE 环境中)                 │
│  - 清除缓存                                     │
│  - 重置网络栈                                   │
│  - 验证系统完整性                               │
│  - 清除 bootsequence                            │
└───────────────────┬─────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────┐
│  自动回到 Windows                               │
│  - PE 清除一次性启动配置                        │
│  - 自动重启                                     │
│  - 启动回主系统                                 │
└─────────────────────────────────────────────────┘
```

### 与简单的 bcdedit 脚本的区别

| 特性 | bcdedit 脚本 | DKTM |
|------|-------------|------|
| **智能决策** | ❌ 无 | ✅ SOSA 算法自动判断 |
| **自动化** | ❌ 需要手动操作 | ✅ 一键完成 |
| **安全性** | ❌ 无检查 | ✅ 多重安全验证 |
| **PE 生成** | ❌ 手动构建 | ✅ 自动生成 |
| **自动恢复** | ❌ 手动回退 | ✅ PE 自动清除 BCD |
| **状态监控** | ❌ 盲目执行 | ✅ 实时系统状态分析 |

**DKTM 不是套壳，而是完整的自动化系统**。

---

## 📁 项目结构

```
DKTM/
├── install.py              # 一键安装脚本
├── hot_restart.py          # 一键热重启脚本 ⭐
├── dktm_config.yaml        # 配置文件（安装后生成）
├── dktm/                   # 核心包
│   ├── adapter.py          # SOSA 适配器
│   ├── executor.py         # 执行器
│   ├── platform_windows.py # Windows 平台操作
│   ├── retina_probe.py     # 状态探测器
│   └── spark_seed_sosa.py  # SOSA 算法
├── tools/                  # 工具脚本
│   ├── build_pe.py         # 自动 PE 生成器
│   └── setup_bcd.py        # BCD 自动配置器
└── docs/                   # 文档
    └── WINPE_BUILD_GUIDE.md
```

---

## 💬 常见问题

**Q: 这和直接在终端输入 bcdedit 有什么区别？**

A: 区别大了！

1. **智能决策**：SOSA 算法自动判断是否安全，bcdedit 不管
2. **自动化**：一个命令完成所有步骤，bcdedit 需要手动操作每一步
3. **自动恢复**：PE 自动清理并回到主系统，bcdedit 需要手动回退
4. **PE 生成**：自动构建和注入，bcdedit 需要手动搞定 WinPE

**DKTM 是完整的自动化系统，不是套壳脚本**。

---

**Q: 为什么不直接写 PE 的壳？**

A: **我们做的就是自动生成 PE**！

`tools/build_pe.py` 自动化了整个 PE 生成过程：
- 自动调用 ADK
- 自动注入 DKTM 脚本
- 自动配置 BCD

你不需要手动操作任何 WinPE 构建步骤。

---

**Q: 真的是一键吗？**

A: **是的！**

```bash
# 安装（只需一次）
python install.py

# 以后每次热重启
python hot_restart.py
```

就这两个命令。

---

**Enjoy your hot restart! 🔥**
